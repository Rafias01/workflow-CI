name: Bank Churn - CI Training & Docker Deployment

permissions:
  contents: write

on:
  push:
    branches: [ main ]
  workflow_dispatch:  

jobs:
  train-and-deploy:
    runs-on: ubuntu-latest
    env:
      PYTHON_VERSION: "3.9"
      MODEL_NAME: "bank-churn-logreg"

    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 

      - name: Setup Python
        uses: actions/setup-python@v4
        with:
          python-version: ${{ env.PYTHON_VERSION }}

      - name: Install required packages
        run: |
          pip install --upgrade pip
          pip install mlflow[extras] scikit-learn pandas joblib cloudpickle

      - name: Train model & log to MLflow (local tracking)
        id: training
        working-directory: MLProject
        run: |
          python modelling.py
          echo "Training selesai, mlruns dibuat"

      - name: Save MLflow tracking permanently to repository
        run: |
          git config user.name "github-actions[bot]"
          git config user.email "actions@github.com"
          
          # Tambah semua file mlruns
          git add MLProject/mlruns || echo "mlruns sudah ada"
          
          # Commit hanya jika ada perubahan
          git status
          if git diff-index --quiet HEAD --; then
            echo "Tidak ada perubahan di mlruns"
          else
            git commit -m "ci: update MLflow tracking & artifacts (run $(date +'%Y-%m-%d %H:%M'))"
            git push origin main
          fi

      - name: Login to Docker Hub
        uses: docker/login-action@v3
        with:
          username: ${{ secrets.DOCKER_USERNAME }}
          password: ${{ secrets.DOCKER_PASSWORD }}

      - name: Build and push Docker image from local model artifact
        working-directory: MLProject
        run: |
          # Validasi artifact model
          [ -d "model" ] && [ -f "model/MLmodel" ] || exit 1
          
          echo "Membangun Docker image..."
          mlflow models build-docker \
            --model-uri "./model" \
            --name "${{ secrets.DOCKER_USERNAME }}/${{ env.MODEL_NAME }}:latest"
          
          echo "Push ke Docker Hub..."
          docker push ${{ secrets.DOCKER_USERNAME }}/${{ env.MODEL_NAME }}:latest
          
          echo "Docker image sukses: https://hub.docker.com/r/${{ secrets.DOCKER_USERNAME }}/${{ env.MODEL_NAME }}"

      - name: Summary
        run: |
          echo "Pipeline CI/CD selesai!"
          echo "Model dilatih & di-log ke mlruns"
          echo "Docker image di-push ke Docker Hub"