name: Bank Churn - CI Training & Save mlruns to Repo

permissions:
  contents: write  

on:
  push:
    branches: [ main ]
  workflow_dispatch:

jobs:
  train-and-save:
    runs-on: ubuntu-latest
    env:
      PYTHON_VERSION: "3.9"

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Python
        uses: actions/setup-python@v4
        with:
          python-version: ${{ env.PYTHON_VERSION }}

      - name: Install dependencies
        run: |
          pip install --upgrade pip
          pip install mlflow[extras] scikit-learn pandas joblib cloudpickle

      - name: Train model & log ke MLflow
        working-directory: MLProject
        run: |
          mlflow run .   # Menggunakan mlflow run sesuai kriteria
          echo "Pelatihan selesai!"
          echo "Folder mlruns telah dibuat di root repo (di luar folder MLProject)"

      - name: Commit dan push folder mlruns ke repo
        run: |
          git config user.name "github-actions[bot]"
          git config user.email "41898282+github-actions[bot]@users.noreply.github.com"

          # Ambil perubahan terbaru dari remote (hindari konflik)
          git pull origin main --rebase

          # Tambahkan folder mlruns yang berada di root repo
          git add mlruns || echo "Tidak ada perubahan di mlruns"

          # Commit hanya jika ada perubahan
          if git diff-index --quiet HEAD --; then
            echo "Tidak ada perubahan baru di mlruns untuk di-commit"
          else
            git commit -m "ci: update mlruns folder after training (new run: ${{ github.run_number }})"
            git push origin main
            echo "Folder mlruns berhasil di-commit dan di-push ke repo!"
          fi

      - name: Summary
        run: |
          echo "========================================"
          echo "PIPELINE CI BERHASIL SELESAI!"
          echo "✓ Model berhasil dilatih menggunakan mlflow run"
          echo "✓ Metrics & model di-log ke MLflow"
          echo "✓ Folder mlruns (lengkap dengan model di dalamnya) telah di-commit ke repo"
          echo "   → Bisa dilihat langsung di: https://github.com/Rafias01/workflow-CI/tree/main/mlruns"
          echo "========================================"