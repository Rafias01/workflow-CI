name: Bank Churn - CI Training MLflow

permissions:
  contents: write

on:
  push:
    branches: [ main ]
  workflow_dispatch:

jobs:
  train:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0  

      - name: Setup Miniconda
        uses: conda-incubator/setup-miniconda@v3
        with:
          python-version: "3.9"
          miniconda-version: "latest"
          activate-environment: mlflow-env
          auto-activate-base: false

      - name: Train model menggunakan MLflow Projects (otomatis pakai conda.yaml)
        working-directory: MLProject
        shell: bash -l {0}  
        run: |
          mlflow run .
          
          echo "Pelatihan selesai!"
          echo "Folder mlruns telah dibuat di: $(pwd)/mlruns"

      - name: Commit dan push folder mlruns ke repo
        run: |
          git config user.name "github-actions[bot]"
          git config user.email "41898282+github-actions[bot]@users.noreply.github.com"
          git pull origin main --rebase
          git add MLProject/mlruns || echo "Tidak ada perubahan di mlruns"
          if git diff-index --quiet HEAD --; then
            echo "Tidak ada perubahan baru di mlruns untuk di-commit"
          else
            git commit -m "ci: update mlruns after training (run: ${{ github.run_number }})"
            git push origin main
            echo "Folder mlruns berhasil di-commit dan di-push ke repo!"
          fi

      - name: Summary
        run: |
          echo "========================================"
          echo "PIPELINE CI BERHASIL SELESAI!"
          echo "✓ Model dilatih menggunakan 'mlflow run' (otomatis pakai conda.yaml)"
          echo "✓ Metrics, parameters, & model artifact di-log ke MLflow"
          echo "✓ Folder mlruns telah di-update dan di-commit ke repo"
          echo "   → Lihat di: https://github.com/Rafias01/workflow-CI/tree/main/MLProject/mlruns"
          echo "========================================"