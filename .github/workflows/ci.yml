name: Bank Churn - CI Training & Docker Deployment

permissions:
  contents: write

on:
  push:
    branches: [ main ]
  workflow_dispatch:  

jobs:
  train-and-deploy:
    runs-on: ubuntu-latest
    env:
      PYTHON_VERSION: "3.9"
      MODEL_NAME: "bank-churn-logreg"
      IMAGE_TAG: ${{ github.sha }}

    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0  # Full history (ubah ke 1 jika ingin lebih cepat)

      - name: Setup Python
        uses: actions/setup-python@v4
        with:
          python-version: ${{ env.PYTHON_VERSION }}

      - name: Install required packages
        run: |
          pip install --upgrade pip
          pip install mlflow[extras] scikit-learn pandas joblib cloudpickle

      - name: Train model & log ke MLflow
        working-directory: MLProject
        run: |
          python modelling.py
          echo "Pelatihan selesai"

      # Optional: Hapus atau ganti dengan remote tracking (hindari repo bloat)
      - name: Simpan MLflow tracking (opsional - hati-hati repo membengkak)
        run: |
          git config user.name "github-actions[bot]"
          git config user.email "actions@github.com"
          git add MLProject/mlruns || echo "Tidak ada mlruns baru"
          if git diff-index --quiet HEAD --; then
            echo "Tidak ada perubahan untuk di-commit"
          else
            git commit -m "ci: update MLflow tracking ($(date +'%Y-%m-%d %H:%M'))"
            git push origin main
          fi

      - name: Login to Docker Hub
        uses: docker/login-action@v3
        with:
          username: ${{ secrets.DOCKER_USERNAME }}
          password: ${{ secrets.DOCKER_PASSWORD }}

      - name: Build & push Docker image
        working-directory: MLProject
        run: |
          [ -d "model" ] && [ -f "model/MLmodel" ] || { echo "Artifact model tidak ditemukan!"; exit 1; }
          
          # Build dengan tag SHA + latest
          mlflow models build-docker \
            --model-uri "./model" \
            --name "${{ secrets.DOCKER_USERNAME }}/${{ env.MODEL_NAME }}:${{ env.IMAGE_TAG }}"
          
          docker tag ${{ secrets.DOCKER_USERNAME }}/${{ env.MODEL_NAME }}:${{ env.IMAGE_TAG }} \
                     ${{ secrets.DOCKER_USERNAME }}/${{ env.MODEL_NAME }}:latest
          
          docker push ${{ secrets.DOCKER_USERNAME }}/${{ env.MODEL_NAME }}:${{ env.IMAGE_TAG }}
          docker push ${{ secrets.DOCKER_USERNAME }}/${{ env.MODEL_NAME }}:latest
          
          echo "Image berhasil: https://hub.docker.com/r/${{ secrets.DOCKER_USERNAME }}/${{ env.MODEL_NAME }}"

      - name: Summary
        run: |
          echo "Pipeline CI/CD selesai!"
          echo "Model telah dilatih dan di-log"
          echo "Docker image telah di-push ke Docker Hub"